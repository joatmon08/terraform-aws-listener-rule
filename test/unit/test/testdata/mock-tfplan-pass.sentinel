terraform_version = "0.14.4"

planned_values = {
	"outputs":   {},
	"resources": {},
}

variables = {
	"region": {
		"name":  "region",
		"value": "us-east-2",
	},
	"services": {
		"name": "services",
		"value": {
			"consul-ingress-gateway-6fd76bdf66-p9qnt.ip-10-0-1-39.us-west-2.compute.internal.cloud": {
				"address":               "10.0.1.39",
				"cts_user_defined_meta": {},
				"id":              "consul-ingress-gateway-6fd76bdf66-p9qnt",
				"kind":            "ingress-gateway",
				"meta":            {},
				"name":            "ingress-gateway",
				"namespace":       null,
				"node":            "ip-10-0-1-39.us-west-2.compute.internal",
				"node_address":    "10.0.1.44",
				"node_datacenter": "cloud",
				"node_id":         "fd1def7c-d139-e1a9-4a96-822ddda3e80b",
				"node_meta": {
					"consul-network-segment": "",
					"pod-name":               "consul-lcdsm",
				},
				"node_tagged_addresses": {
					"lan":      "10.0.1.44",
					"lan_ipv4": "10.0.1.44",
					"wan":      "10.0.1.44",
					"wan_ipv4": "10.0.1.44",
				},
				"port":   30909,
				"status": "passing",
				"tags":   [],
			},
			"my-application-575957b495-24cw4-my-application.ip-10-0-1-12.us-west-2.compute.internal.cloud": {
				"address":               "10.0.1.4",
				"cts_user_defined_meta": {},
				"id":   "my-application-575957b495-24cw4-my-application",
				"kind": "",
				"meta": {
					"host":     "my-application.my-company.net",
					"pod-name": "my-application-575957b495-24cw4",
					"weight":   "0",
				},
				"name":            "my-application",
				"namespace":       null,
				"node":            "ip-10-0-1-12.us-west-2.compute.internal",
				"node_address":    "10.0.1.9",
				"node_datacenter": "cloud",
				"node_id":         "58df9b87-bf3a-61b9-6e00-30e8f6ec9b23",
				"node_meta": {
					"consul-network-segment": "",
					"pod-name":               "consul-2mpz6",
				},
				"node_tagged_addresses": {
					"lan":      "10.0.1.9",
					"lan_ipv4": "10.0.1.9",
					"wan":      "10.0.1.9",
					"wan_ipv4": "10.0.1.9",
				},
				"port":   9090,
				"status": "passing",
				"tags":   [],
			},
			"my-application-575957b495-cdvgw-my-application.ip-10-0-1-39.us-west-2.compute.internal.cloud": {
				"address":               "10.0.1.36",
				"cts_user_defined_meta": {},
				"id":   "my-application-575957b495-cdvgw-my-application",
				"kind": "",
				"meta": {
					"host":     "my-application.my-company.net",
					"pod-name": "my-application-575957b495-cdvgw",
					"weight":   "0",
				},
				"name":            "my-application",
				"namespace":       null,
				"node":            "ip-10-0-1-39.us-west-2.compute.internal",
				"node_address":    "10.0.1.44",
				"node_datacenter": "cloud",
				"node_id":         "fd1def7c-d139-e1a9-4a96-822ddda3e80b",
				"node_meta": {
					"consul-network-segment": "",
					"pod-name":               "consul-lcdsm",
				},
				"node_tagged_addresses": {
					"lan":      "10.0.1.44",
					"lan_ipv4": "10.0.1.44",
					"wan":      "10.0.1.44",
					"wan_ipv4": "10.0.1.44",
				},
				"port":   9090,
				"status": "passing",
				"tags":   [],
			},
			"my-application-575957b495-qxqhx-my-application.ip-10-0-1-30.us-west-2.compute.internal.cloud": {
				"address":               "10.0.1.20",
				"cts_user_defined_meta": {},
				"id":   "my-application-575957b495-qxqhx-my-application",
				"kind": "",
				"meta": {
					"host":     "my-application.my-company.net",
					"pod-name": "my-application-575957b495-qxqhx",
					"weight":   "0",
				},
				"name":            "my-application",
				"namespace":       null,
				"node":            "ip-10-0-1-30.us-west-2.compute.internal",
				"node_address":    "10.0.1.27",
				"node_datacenter": "cloud",
				"node_id":         "3b545e12-1de4-49b8-8b06-80c7f06f9810",
				"node_meta": {
					"consul-network-segment": "",
					"pod-name":               "consul-62srk",
				},
				"node_tagged_addresses": {
					"lan":      "10.0.1.27",
					"lan_ipv4": "10.0.1.27",
					"wan":      "10.0.1.27",
					"wan_ipv4": "10.0.1.27",
				},
				"port":   9090,
				"status": "passing",
				"tags":   [],
			},
		},
	},
}

resource_changes = {}

output_changes = {
	"listener_rule_arn": {
		"change": {
			"actions": [
				"delete",
			],
			"after":         null,
			"after_unknown": false,
			"before":        null,
		},
		"name": "listener_rule_arn",
	},
	"target_group_arn": {
		"change": {
			"actions": [
				"delete",
			],
			"after":         null,
			"after_unknown": false,
			"before":        null,
		},
		"name": "target_group_arn",
	},
}

raw = {
	"configuration": {
		"provider_config": {
			"aws": {
				"expressions": {
					"region": {
						"references": [
							"var.region",
						],
					},
				},
				"name": "aws",
			},
		},
		"root_module": {
			"module_calls": {
				"listener_rule": {
					"expressions": {
						"blue_target_group_arn": {
							"references": [
								"aws_lb_target_group.module_test",
							],
						},
						"health_check_path": {
							"constant_value": "/health",
						},
						"listener_arn": {
							"references": [
								"aws_lb_listener.module_test",
							],
						},
						"services": {
							"references": [
								"var.services",
							],
						},
						"vpc_id": {
							"references": [
								"data.aws_vpc.selected",
							],
						},
					},
					"module": {
						"outputs": {
							"listener_rule_arn": {
								"expression": {
									"references": [
										"aws_lb_listener_rule.app_canary",
									],
								},
							},
							"target_group_arn": {
								"expression": {
									"references": [
										"aws_lb_target_group.canary",
									],
								},
							},
						},
						"resources": [
							{
								"address": "aws_lb_listener_rule.app_canary",
								"expressions": {
									"action": [
										{
											"forward": [
												{
													"stickiness": [
														{
															"duration": {
																"references": [
																	"var.stickiness_duration",
																],
															},
															"enabled": {
																"references": [
																	"var.enable_stickiness",
																],
															},
														},
													],
													"target_group": [
														{
															"arn": {
																"references": [
																	"var.blue_target_group_arn",
																],
															},
															"weight": {
																"references": [
																	"local.weight",
																],
															},
														},
														{
															"arn": {
																"references": [
																	"aws_lb_target_group.canary",
																],
															},
															"weight": {
																"references": [
																	"local.weight",
																],
															},
														},
													],
												},
											],
											"type": {
												"constant_value": "forward",
											},
										},
									],
									"condition": [
										{
											"host_header": [
												{
													"values": {
														"references": [
															"local.host",
														],
													},
												},
											],
										},
									],
									"listener_arn": {
										"references": [
											"var.listener_arn",
										],
									},
									"priority": {
										"references": [
											"var.listener_rule_priority",
										],
									},
								},
								"mode":                "managed",
								"name":                "app_canary",
								"provider_config_key": "listener_rule:aws",
								"schema_version":      0,
								"type":                "aws_lb_listener_rule",
							},
							{
								"address": "aws_lb_target_group.canary",
								"expressions": {
									"health_check": [
										{
											"enabled": {
												"constant_value": true,
											},
											"path": {
												"references": [
													"var.health_check_path",
												],
											},
										},
									],
									"name": {
										"references": [
											"local.name",
											"local.datacenter",
										],
									},
									"port": {
										"references": [
											"local.port",
										],
									},
									"protocol": {
										"constant_value": "HTTP",
									},
									"target_type": {
										"constant_value": "ip",
									},
									"vpc_id": {
										"references": [
											"var.vpc_id",
										],
									},
								},
								"mode":                "managed",
								"name":                "canary",
								"provider_config_key": "listener_rule:aws",
								"schema_version":      0,
								"type":                "aws_lb_target_group",
							},
							{
								"address": "aws_lb_target_group_attachment.app_canary",
								"expressions": {
									"availability_zone": {
										"constant_value": "all",
									},
									"port": {
										"references": [
											"local.port",
										],
									},
									"target_group_arn": {
										"references": [
											"aws_lb_target_group.canary",
										],
									},
									"target_id": {
										"references": [
											"each.value",
										],
									},
								},
								"for_each_expression": {
									"references": [
										"local.ip_addresses",
									],
								},
								"mode":                "managed",
								"name":                "app_canary",
								"provider_config_key": "listener_rule:aws",
								"schema_version":      0,
								"type":                "aws_lb_target_group_attachment",
							},
						],
						"variables": {
							"blue_target_group_arn": {
								"description": "ARN of blue target group (existing target group with working application)",
							},
							"enable_stickiness": {
								"default":     false,
								"description": "Enable stickiness",
							},
							"green_weight": {
								"default":     0,
								"description": "Percentage of traffic to send to green deployment",
							},
							"health_check_path": {
								"default":     "/health",
								"description": "Path of health check for applications",
							},
							"listener_arn": {
								"description": "ARN of listener to update",
							},
							"listener_rule_priority": {
								"default":     1,
								"description": "Priority of listener rule between 1 to 50000",
							},
							"service_kind": {
								"default":     "",
								"description": "Kind of Consul service. Can be ingress-gateway, terminating-gateway.",
							},
							"services": {
								"description": "Consul services monitored by Consul-Terraform-Sync",
							},
							"stickiness_duration": {
								"default":     600,
								"description": "Duration of stickness in seconds",
							},
							"vpc_id": {
								"description": "ID of the VPC for the target group",
							},
						},
					},
					"source": "../",
				},
			},
			"outputs": {
				"listener_rule_arn": {
					"expression": {
						"references": [
							"module.listener_rule.listener_rule_arn",
						],
					},
				},
				"target_group_arn": {
					"expression": {
						"references": [
							"module.listener_rule.target_group_arn",
						],
					},
				},
			},
			"resources": [
				{
					"address": "aws_lb.module_test",
					"expressions": {
						"enable_deletion_protection": {
							"constant_value": false,
						},
						"internal": {
							"constant_value": false,
						},
						"load_balancer_type": {
							"constant_value": "application",
						},
						"name": {
							"references": [
								"local.module_name",
							],
						},
						"subnets": {
							"references": [
								"data.aws_subnet_ids.selected",
							],
						},
						"tags": {
							"references": [
								"local.tags",
							],
						},
					},
					"mode":                "managed",
					"name":                "module_test",
					"provider_config_key": "aws",
					"schema_version":      0,
					"type":                "aws_lb",
				},
				{
					"address": "aws_lb_listener.module_test",
					"expressions": {
						"default_action": [
							{
								"target_group_arn": {
									"references": [
										"aws_lb_target_group.module_test",
									],
								},
								"type": {
									"constant_value": "forward",
								},
							},
						],
						"load_balancer_arn": {
							"references": [
								"aws_lb.module_test",
							],
						},
						"port": {
							"constant_value": "80",
						},
						"protocol": {
							"constant_value": "HTTP",
						},
					},
					"mode":                "managed",
					"name":                "module_test",
					"provider_config_key": "aws",
					"schema_version":      0,
					"type":                "aws_lb_listener",
				},
				{
					"address": "aws_lb_target_group.module_test",
					"expressions": {
						"health_check": [
							{
								"enabled": {
									"constant_value": true,
								},
							},
						],
						"name": {
							"references": [
								"local.module_name",
							],
						},
						"port": {
							"constant_value": 9090,
						},
						"protocol": {
							"constant_value": "HTTP",
						},
						"target_type": {
							"constant_value": "ip",
						},
						"vpc_id": {
							"references": [
								"data.aws_vpc.selected",
							],
						},
					},
					"mode":                "managed",
					"name":                "module_test",
					"provider_config_key": "aws",
					"schema_version":      0,
					"type":                "aws_lb_target_group",
				},
				{
					"address": "data.aws_subnet_ids.selected",
					"expressions": {
						"vpc_id": {
							"references": [
								"data.aws_vpc.selected",
							],
						},
					},
					"mode":                "data",
					"name":                "selected",
					"provider_config_key": "aws",
					"schema_version":      0,
					"type":                "aws_subnet_ids",
				},
				{
					"address": "data.aws_vpc.selected",
					"expressions": {
						"default": {
							"constant_value": true,
						},
					},
					"mode":                "data",
					"name":                "selected",
					"provider_config_key": "aws",
					"schema_version":      0,
					"type":                "aws_vpc",
				},
			],
			"variables": {
				"region": {
					"description": "AWS region",
				},
				"services": {
					"description": "Consul services monitored by Consul-Terraform-Sync",
				},
			},
		},
	},
	"format_version": "0.1",
	"output_changes": {
		"listener_rule_arn": {
			"actions": [
				"delete",
			],
			"after_unknown": false,
			"before":        null,
		},
		"target_group_arn": {
			"actions": [
				"delete",
			],
			"after_unknown": false,
			"before":        null,
		},
	},
	"planned_values": {
		"root_module": {},
	},
	"terraform_version": "0.14.4",
	"variables": {
		"region": {
			"value": "us-east-2",
		},
		"services": {
			"value": {
				"consul-ingress-gateway-6fd76bdf66-p9qnt.ip-10-0-1-39.us-west-2.compute.internal.cloud": {
					"address":               "10.0.1.39",
					"cts_user_defined_meta": {},
					"id":              "consul-ingress-gateway-6fd76bdf66-p9qnt",
					"kind":            "ingress-gateway",
					"meta":            {},
					"name":            "ingress-gateway",
					"namespace":       null,
					"node":            "ip-10-0-1-39.us-west-2.compute.internal",
					"node_address":    "10.0.1.44",
					"node_datacenter": "cloud",
					"node_id":         "fd1def7c-d139-e1a9-4a96-822ddda3e80b",
					"node_meta": {
						"consul-network-segment": "",
						"pod-name":               "consul-lcdsm",
					},
					"node_tagged_addresses": {
						"lan":      "10.0.1.44",
						"lan_ipv4": "10.0.1.44",
						"wan":      "10.0.1.44",
						"wan_ipv4": "10.0.1.44",
					},
					"port":   30909,
					"status": "passing",
					"tags":   [],
				},
				"my-application-575957b495-24cw4-my-application.ip-10-0-1-12.us-west-2.compute.internal.cloud": {
					"address":               "10.0.1.4",
					"cts_user_defined_meta": {},
					"id":   "my-application-575957b495-24cw4-my-application",
					"kind": "",
					"meta": {
						"host":     "my-application.my-company.net",
						"pod-name": "my-application-575957b495-24cw4",
						"weight":   "0",
					},
					"name":            "my-application",
					"namespace":       null,
					"node":            "ip-10-0-1-12.us-west-2.compute.internal",
					"node_address":    "10.0.1.9",
					"node_datacenter": "cloud",
					"node_id":         "58df9b87-bf3a-61b9-6e00-30e8f6ec9b23",
					"node_meta": {
						"consul-network-segment": "",
						"pod-name":               "consul-2mpz6",
					},
					"node_tagged_addresses": {
						"lan":      "10.0.1.9",
						"lan_ipv4": "10.0.1.9",
						"wan":      "10.0.1.9",
						"wan_ipv4": "10.0.1.9",
					},
					"port":   9090,
					"status": "passing",
					"tags":   [],
				},
				"my-application-575957b495-cdvgw-my-application.ip-10-0-1-39.us-west-2.compute.internal.cloud": {
					"address":               "10.0.1.36",
					"cts_user_defined_meta": {},
					"id":   "my-application-575957b495-cdvgw-my-application",
					"kind": "",
					"meta": {
						"host":     "my-application.my-company.net",
						"pod-name": "my-application-575957b495-cdvgw",
						"weight":   "0",
					},
					"name":            "my-application",
					"namespace":       null,
					"node":            "ip-10-0-1-39.us-west-2.compute.internal",
					"node_address":    "10.0.1.44",
					"node_datacenter": "cloud",
					"node_id":         "fd1def7c-d139-e1a9-4a96-822ddda3e80b",
					"node_meta": {
						"consul-network-segment": "",
						"pod-name":               "consul-lcdsm",
					},
					"node_tagged_addresses": {
						"lan":      "10.0.1.44",
						"lan_ipv4": "10.0.1.44",
						"wan":      "10.0.1.44",
						"wan_ipv4": "10.0.1.44",
					},
					"port":   9090,
					"status": "passing",
					"tags":   [],
				},
				"my-application-575957b495-qxqhx-my-application.ip-10-0-1-30.us-west-2.compute.internal.cloud": {
					"address":               "10.0.1.20",
					"cts_user_defined_meta": {},
					"id":   "my-application-575957b495-qxqhx-my-application",
					"kind": "",
					"meta": {
						"host":     "my-application.my-company.net",
						"pod-name": "my-application-575957b495-qxqhx",
						"weight":   "0",
					},
					"name":            "my-application",
					"namespace":       null,
					"node":            "ip-10-0-1-30.us-west-2.compute.internal",
					"node_address":    "10.0.1.27",
					"node_datacenter": "cloud",
					"node_id":         "3b545e12-1de4-49b8-8b06-80c7f06f9810",
					"node_meta": {
						"consul-network-segment": "",
						"pod-name":               "consul-62srk",
					},
					"node_tagged_addresses": {
						"lan":      "10.0.1.27",
						"lan_ipv4": "10.0.1.27",
						"wan":      "10.0.1.27",
						"wan_ipv4": "10.0.1.27",
					},
					"port":   9090,
					"status": "passing",
					"tags":   [],
				},
			},
		},
	},
}
